Description: S3 object-level API operations such as GetObject, DeleteObject, and PutObject are called data events. By default, CloudTrail trails don't log data events and so it is recommended to enable Object-level logging for S3 buckets.
ID: aws_cis_v140_3_10
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables:
    - aws_cloudtrail_trail
    - aws_s3_bucket
  Parameters: []
  PrimaryTable: aws_s3_bucket
  QueryToExecute: |
    WITH s3_selectors AS (
      SELECT
        name AS trail_name,
        is_multi_region_trail,
        bucket_selector
      FROM
        aws_cloudtrail_trail,
        jsonb_array_elements(event_selectors) AS event_selector,
        jsonb_array_elements(event_selector -> 'DataResources') AS data_resource,
        jsonb_array_elements_text(data_resource -> 'Values') AS bucket_selector
      WHERE
        is_multi_region_trail
        AND data_resource ->> 'Type' = 'AWS::S3::Object'
        AND event_selector ->> 'ReadWriteType' IN ('WriteOnly', 'All')
    )
    SELECT
      b.arn AS resource,
      b.og_account_id AS og_account_id,
      b.og_resource_id AS og_resource_id,
      CASE
        WHEN COUNT(bucket_selector) > 0 THEN 'ok'
        ELSE 'alarm'
      END AS status,
      CASE
        WHEN COUNT(bucket_selector) > 0 
        THEN b.name || ' object-level write events logging enabled.'
        ELSE b.name || ' object-level write events logging disabled.'
      END AS reason
    FROM
      aws_s3_bucket AS b
    LEFT JOIN
      s3_selectors
      ON bucket_selector LIKE (b.arn || '%')
      OR bucket_selector = 'arn:aws:s3'
    GROUP BY
      b.account_id, b.region, b.arn, b.name, b.tags, b._ctx;
Severity: low
Tags: {}
Title: 3.10 Ensure that Object-level logging for write events is enabled for S3 bucket