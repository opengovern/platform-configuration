ID: aws_mandatory_sql_s3_bucket_mandatory
Title: "S3 buckets should have mandatory tags"
Description: "Check if S3 buckets have mandatory tags."
Query:
  Engine: steampipe-v0.5
  QueryToExecute: "with analysis as (\n  select\n    og_account_id,\n    og_resource_id,\n    arn,\n    title,\n    tags ?& '{{.awsMandatoryTags}}'::text[] as has_mandatory_tags,\n    to_jsonb('{{.awsMandatoryTags}}'::text[]) - array(select jsonb_object_keys(tags)) as missing_tags,\n    region,\n    account_id,\n    tags,\n    _ctx\n  from\n    aws_s3_bucket\n)\nselect\n    og_account_id,\n    og_resource_id,\n    arn as resource,\n  case\n    when has_mandatory_tags then 'ok'\n    else 'alarm'\n  end as status,\n  case\n    when has_mandatory_tags then title || ' has all mandatory tags.'\n    else title || ' is missing tags: ' || array_to_string(array(select jsonb_array_elements_text(missing_tags)), ', ') || '.'\n  end as reason\n  \n  , region, account_id\nfrom\n  analysis;\n"
  PrimaryTable: aws_s3_bucket
  ListOfTables:
    - aws_s3_bucket
  Parameters:
    - key: awsMandatoryTags
      required: true
Severity: high
Tags: {}
IntegrationTypeName:
  - aws_cloud
