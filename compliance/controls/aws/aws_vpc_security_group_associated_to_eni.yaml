ID: aws_vpc_security_group_associated_to_eni
Title: "VPC security groups should be associated with at least one ENI"
Description: "This rule ensures the security groups are attached to an AWS Elastic Compute Cloud (AWS EC2) instance or to an ENI. This rule helps monitoring unused security groups in the inventory and the management of your environment."
Query:
  Engine: CloudQL-v0.0.1
  QueryToExecute: "with associated_sg as (\n  select\n    count(sg ->> 'GroupId'),\n    sg ->> 'GroupId' as secgrp_id\n  from\n    aws_ec2_network_interface,\n    jsonb_array_elements(groups) as sg\n    group by sg ->> 'GroupId'\n)\nselect\n  distinct s.arn as resource,\n  s.og_account_id as og_account_id,\n  s.og_resource_id as og_resource_id,\n  case\n    when a.secgrp_id = s.group_id then 'ok'\n    else 'alarm'\n  end as status,\n  case\n    when a.secgrp_id = s.group_id then s.title || ' is associated with ' || a.count || ' ENI(s).'\n    else s.title || ' not associated to any ENI.'\n  end as reason\n  \n  , region, account_id\nfrom\n  aws_vpc_security_group as s\n  left join associated_sg as a on s.group_id = a.secgrp_id;\n"
  PrimaryTable: aws_vpc_security_group
  ListOfTables:
    - aws_ec2_network_interface
    - aws_vpc_security_group
  Parameters: []
Severity: low
Tags:
  category:
    - Compliance
  cis_controls_v8_ig1:
    - "true"
  nist_800_171_rev_2:
    - "true"
  plugin:
    - aws
  service:
    - AWS/VPC
  soc_2:
    - "true"
IntegrationTypeName:
  - aws_cloud
