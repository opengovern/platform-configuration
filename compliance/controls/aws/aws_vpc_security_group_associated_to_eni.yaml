Description: This rule ensures the security groups are attached to an AWS Elastic Compute Cloud (AWS EC2) instance or to an ENI. This rule helps monitoring unused security groups in the inventory and the management of your environment.
ID: aws_vpc_security_group_associated_to_eni
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables:
    - aws_ec2_network_interface
    - aws_vpc_security_group
  Parameters: []
  PrimaryTable: aws_vpc_security_group
  QueryToExecute: |
    WITH associated_sg AS (
      SELECT
        COUNT(sg ->> 'GroupId'),
        sg ->> 'GroupId' AS secgrp_id
      FROM
        aws_ec2_network_interface,
        JSONB_ARRAY_ELEMENTS(groups) AS sg
      GROUP BY
        sg ->> 'GroupId'
    )
    SELECT
      DISTINCT s.arn AS resource,
      s.og_account_id AS og_account_id,
      s.og_resource_id AS og_resource_id,
      CASE
        WHEN a.secgrp_id = s.group_id THEN 'ok'
        ELSE 'alarm'
      END AS status,
      CASE
        WHEN a.secgrp_id = s.group_id THEN s.title || ' is associated with ' || a.count || ' ENI(s).'
        ELSE s.title || ' not associated to any ENI.'
      END AS reason,
      region,
      account_id
    FROM
      aws_vpc_security_group AS s
    LEFT JOIN
      associated_sg AS a ON s.group_id = a.secgrp_id;
Severity: low
Tags:
  category:
    - Compliance
  cis_controls_v8_ig1:
    - "true"
  nist_800_171_rev_2:
    - "true"
  plugin:
    - aws
  service:
    - AWS/VPC
  soc_2:
    - "true"
Title: VPC security groups should be associated with at least one ENI