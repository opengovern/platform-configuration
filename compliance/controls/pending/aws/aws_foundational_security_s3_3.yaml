Description: This control checks whether your S3 buckets allow public write access. It evaluates the block public access settings, the bucket policy, and the bucket access control list (ACL).
ID: aws_foundational_security_s3_3
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables: []
  Parameters: []
  PrimaryTable: ""
  QueryToExecute: |
    WITH public_acl AS (
      SELECT DISTINCT name
      FROM aws_s3_bucket,
           jsonb_array_elements(acl -> 'Grants') AS grants
      WHERE 
        (grants -> 'Grantee' ->> 'URI' = 'http://acs.amazonaws.com/groups/global/AllUsers'
        OR grants -> 'Grantee' ->> 'URI' = 'http://acs.amazonaws.com/groups/global/AuthenticatedUsers')
        AND (grants ->> 'Permission' = 'FULL_CONTROL'
          OR grants ->> 'Permission' = 'WRITE_ACP'
          OR grants ->> 'Permission' = 'WRITE')
    ), write_access_policy AS (
      SELECT DISTINCT name
      FROM aws_s3_bucket,
           jsonb_array_elements(policy_std -> 'Statement') AS s,
           jsonb_array_elements_text(s -> 'Action') AS action
      WHERE 
        s ->> 'Effect' = 'Allow'
        AND (s -> 'Principal' -> 'AWS' = '[\"*\"]'
          OR s ->> 'Principal' = '*')
        AND (action = '*'
          OR action = '*:*'
          OR action = 's3:*'
          OR action ILIKE 's3:put%'
          OR action ILIKE 's3:delete%'
          OR action ILIKE 's3:create%'
          OR action ILIKE 's3:update%'
          OR action ILIKE 's3:replicate%'
          OR action ILIKE 's3:restore%')
    )
    SELECT 
      b.arn AS resource,
      CASE
        WHEN (block_public_acls OR a.name IS NULL) AND NOT bucket_policy_is_public THEN 'ok'
        WHEN (block_public_acls OR a.name IS NULL) AND bucket_policy_is_public AND block_public_policy THEN 'ok'
        WHEN bucket_policy_is_public AND p.name IS NULL THEN 'ok'
        ELSE 'alarm'
      END status,
      CASE
        WHEN (block_public_acls OR a.name IS NULL) AND NOT bucket_policy_is_public THEN b.title || ' not publicly writable.'
        WHEN (block_public_acls OR a.name IS NULL) AND bucket_policy_is_public AND block_public_policy THEN b.title || ' not publicly writable.'
        WHEN (block_public_acls OR a.name IS NULL) AND bucket_policy_is_public AND p.name IS NULL THEN b.title || ' not publicly writable.'
        ELSE b.title || ' publicly writable.'
      END reason
    FROM aws_s3_bucket AS b
    LEFT JOIN public_acl AS a ON b.name = a.name
    LEFT JOIN write_access_policy AS p ON b.name = p.name;
Severity: critical
Tags: {}
Title: 3 S3 buckets should prohibit public write access