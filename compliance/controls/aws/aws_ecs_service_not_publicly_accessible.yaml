Description: This control checks whether AWS ECS services are configured to automatically assign public IP addresses. This control fails if AssignPublicIP is enabled.
ID: aws_ecs_service_not_publicly_accessible
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables:
    - aws_ecs_service
    - aws_ecs_task_definition
  Parameters: []
  PrimaryTable: aws_ecs_service
  QueryToExecute: |
    WITH service_awsvpc_mode_task_definition AS (
      SELECT
        a.service_name AS service_name,
        b.task_definition_arn AS task_definition
      FROM
        aws_ecs_service AS a
      LEFT JOIN aws_ecs_task_definition AS b
        ON a.task_definition = b.task_definition_arn
      WHERE
        b.network_mode = 'awsvpc'
    )
    SELECT
      a.arn AS resource,
      a.og_account_id AS og_account_id,
      a.og_resource_id AS og_resource_id,
      CASE
        WHEN b.service_name IS NULL THEN 'skip'
        WHEN network_configuration -> 'AwsvpcConfiguration' ->> 'AssignPublicIp' = 'DISABLED' THEN 'ok'
        ELSE 'alarm'
      END AS status,
      CASE
        WHEN b.service_name IS NULL THEN a.title || ' task definition not host network mode.'
        WHEN network_configuration -> 'AwsvpcConfiguration' ->> 'AssignPublicIp' = 'DISABLED' THEN a.title || ' not publicly accessible.'
        ELSE a.title || ' publicly accessible.'
      END AS reason,
      region,
      account_id
    FROM
      aws_ecs_service AS a
    LEFT JOIN service_awsvpc_mode_task_definition AS b
      ON a.service_name = b.service_name
Severity: high
Tags:
  aws_foundational_security:
    - "true"
  category:
    - Compliance
  foundational_security_category:
    - resources_not_publicly_accessible
  foundational_security_item_id:
    - ecs_2
  plugin:
    - aws
  service:
    - AWS/ECS
Title: AWS ECS services should not have public IP addresses assigned to them automatically