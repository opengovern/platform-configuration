Description: This control checks whether an Amazon EC2 Auto Scaling group uses multiple instance types. The control fails if the Auto Scaling group has only one instance type defined.
ID: aws_foundational_security_autoscaling_6
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables:
    - aws_ec2_autoscaling_group
  Parameters: []
  PrimaryTable: aws_ec2_autoscaling_group
  QueryToExecute: |
    WITH autoscaling_groups AS (
      SELECT
        autoscaling_group_arn,
        title,
        mixed_instances_policy_launch_template_overrides,
        region,
        tags,
        _ctx,
        account_id
      FROM
        aws_ec2_autoscaling_group
    ),
    distinct_instance_types_count AS (
      SELECT
        autoscaling_group_arn,
        COUNT(DISTINCT(e -> 'InstanceType')) AS distinct_instance_types
      FROM
        autoscaling_groups,
        jsonb_array_elements(mixed_instances_policy_launch_template_overrides) AS e
      GROUP BY
        autoscaling_group_arn,
        title,
        mixed_instances_policy_launch_template_overrides
    )
    SELECT
      a.autoscaling_group_arn AS resource,
      a.og_account_id AS og_account_id,
      a.og_resource_id AS og_resource_id,
      CASE
        WHEN b.distinct_instance_types > 1 THEN 'ok'
        ELSE 'alarm'
      END AS status,
      CASE
        WHEN b.distinct_instance_types > 1 THEN title || ' uses ' || b.distinct_instance_types || ' instance types.'
        ELSE title || ' does not use multiple instance types.'
      END AS reason
    FROM
      autoscaling_groups AS a
      LEFT JOIN distinct_instance_types_count AS b ON a.autoscaling_group_arn = b.autoscaling_group_arn;
Severity: medium
Tags: {}
Title: 6 Auto Scaling groups should use multiple instance types in multiple Availability Zones