ID: og_connection_mom_cost_growth
Title: "MoM growth for a connection that has a cost more than a certain amount cannot grow more than a certain percentage"
Description: "MoM growth for a connection that has a cost more than a certain amount cannot grow more than a certain percentage"
Query:
  Engine: odysseus-v0.0.1
  QueryToExecute: "with last30 as (\n  SELECT connection_id, SUM(cost_value) as cost_value\n  FROM og_cost\n  WHERE period_start::timestamp >= NOW() - interval '31 days' and period_end::timestamp <= NOW()\n  GROUP BY connection_id\n),\nlast60to30 as (\n  SELECT connection_id, SUM(cost_value) as cost_value\n  FROM og_cost\n  WHERE period_start::timestamp >= NOW() - interval '62 days' and period_end::timestamp <= NOW() - interval '31 days'\n  GROUP BY connection_id\n),\nlast_valid_60 as (\n  SELECT \n    l.connection_id as connection_id,\n    l.cost_value as last30_cost_value,\n    s.cost_value as last60to30_cost_value\n  FROM last30 as l JOIN last60to30 as s on (l.connection_id = s.connection_id)\n  WHERE l.cost_value > {{.kaytuConnectionMoMCostGrowthMinCost}}\n)\nSELECT \n  case \n    when aw.account_id IS NOT NULL then aw.account_id\n    when az.subscription_id IS NOT NULL then az.subscription_id\n  end as resource,\n  case\n    when aw.og_account_id IS NOT NULL then aw.og_account_id\n    when az.og_account_id IS NOT NULL then az.og_account_id\n  end as og_account_id,\n  case\n    when aw.og_resource_id IS NOT NULL then aw.og_resource_id\n    when az.og_resource_id IS NOT NULL then az.og_resource_id\n  end as og_resource_id,\n  case\n    when aw.account_id IS NOT NULL then 'aws_account'\n    when az.subscription_id IS NOT NULL then 'azure_subscription'\n  end as og_table_name, \n  case \n  when (l.last30_cost_value - l.last60to30_cost_value) / l.last30_cost_value > {{.kaytuConnectionMoMCostGrowthAllowedGrowth}} then 'alarm'\n  else 'ok'\n  end as status,\n  case \n  when aw.account_id IS NOT NULL AND (l.last30_cost_value - l.last60to30_cost_value) / l.last30_cost_value > {{.kaytuConnectionMoMCostGrowthAllowedGrowth}} then aw.account_id || ' cost grew from ' || l.last60to30_cost_value || ' to ' || l.last30_cost_value || ' which is more than allowed growth'\n  when az.subscription_id IS NOT NULL AND (l.last30_cost_value - l.last60to30_cost_value) / l.last30_cost_value > {{.kaytuConnectionMoMCostGrowthAllowedGrowth}} then az.subscription_id || ' cost grew from ' || l.last60to30_cost_value || ' to ' || l.last30_cost_value || ' which is more than allowed growth'\n  else 'Connection did not have more than allowed growth'\n  end as reason\nFROM last_valid_60 as l \n  left join aws_account as aw on aw.og_account_id = l.connection_id\n  left join azure_subscription as az on az.og_account_id = l.connection_id\n"
  PrimaryTable: ""
  ListOfTables:
    - aws_account
    - azure_subscription
  Parameters:
    - Key: kaytuConnectionMoMCostGrowthMinCost
      Required: true
    - Key: kaytuConnectionMoMCostGrowthAllowedGrowth
      Required: true
Severity: high
Tags:
  platform_score_cloud_service_name:
    - TODO
  platform_score_use_case:
    - TODO
  score_service_name:
    - TODO
  score_tags:
    - TODO
IntegrationTypeName:
  - aws_cloud
  - azure_subscription
