Description: This policy identifies Azure Storage account containing VHD OS disk which are not encrypted with CMK. VHD's attached to Virtual Machines are stored in Azure storage. By default Azure Storage account is encrypted using Microsoft Managed Keys. It is recommended to use Customer Managed Keys to encrypt data in Azure Storage accounts for better control on the data.
ID: azure_storage_account_containing_vhd_os_disk_cmk_encrypted
IntegrationType:
  - azure_subscription
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables: []
  Parameters: []
  PrimaryTable: ""
  QueryToExecute: |
    SELECT
      sa.id AS resource,
      CASE
        WHEN sa.encryption_key_source = 'Microsoft.Storage'
        AND vm.os_disk_vhd_uri IS NOT NULL THEN 'alarm'
        ELSE 'ok'
      END AS status,
      CASE
        WHEN sa.encryption_key_source = 'Microsoft.Storage'
        AND vm.os_disk_vhd_uri IS NOT NULL THEN sa.name || ' storage account containing VHD OS disk not encrypted with CMK.'
        ELSE sa.name || ' storage account containing VHD OS disk encrypted with CMK.'
      END AS reason
    FROM
      azure_storage_account sa,
      azure_compute_virtual_machine vm,
      azure_subscription sub
    WHERE
      sub.subscription_id = sa.subscription_id
      AND vm.os_disk_vhd_uri LIKE '%' || sa.name || '%';
Severity: low
Tags: {}
Title: Storage account containing VHD OS disk not encrypted with CMK