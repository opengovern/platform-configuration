Description: Manage access to resources in the AWS Cloud by ensuring hardware MFA is enabled for the user.
ID: aws_iam_user_hardware_mfa_enabled
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables: []
  Parameters: []
  PrimaryTable: ""
  QueryToExecute: |
    SELECT
      u.arn AS resource,
      CASE
        WHEN serial_number IS NULL THEN 'alarm'
        WHEN serial_number LIKE ANY(ARRAY['%mfa%', '%sms-mfa%']) THEN 'info'
        ELSE 'ok'
      END AS status,
      CASE
        WHEN serial_number IS NULL THEN u.name || ' MFA device not configured.'
        WHEN serial_number LIKE ANY(ARRAY['%mfa%', '%sms-mfa%']) THEN u.name || ' MFA enabled, but the MFA associated is a virtual device.'
        ELSE u.name || ' hardware MFA device enabled.'
      END AS reason
    FROM
      aws_iam_virtual_mfa_device AS m
    RIGHT JOIN
      aws_iam_user AS u
    ON
      m.user_id = u.user_id;
Severity: low
Tags: {}
Title: IAM users should have hardware MFA enabled