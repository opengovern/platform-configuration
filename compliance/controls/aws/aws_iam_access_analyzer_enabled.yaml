ID: aws_iam_access_analyzer_enabled
Title: "Ensure that IAM Access analyzer is enabled for all regions"
Description: "This control checks whether IAM Access analyzer is enabled for all regions. The control fails if IAM Access analyzer is not enabled for all regions."
Query:
  Engine: CloudQL-v0.0.1
  QueryToExecute: "with regions as (\n  select\n    'arn:' || r.partition || '::' || r.region || ':' || r.account_id as resource,\n    r.og_account_id as og_account_id,\n    r.og_resource_id as og_resource_id,\n    case\n      when r.opt_in_status = 'not-opted-in' then 1\n      when aa.arn is not null then 0\n      else 2\n    end as status,\n    r.region, r.account_id\n  from\n    aws_region as r\n      left join aws_accessanalyzer_analyzer as aa on r.account_id = aa.account_id and r.region = aa.region\n),\nresults as (\n  SELECT\n    account_id AS resource,\n    og_account_id as og_account_id,\n    og_account_id as og_resource_id,\n    case\n      when max(status) = 2 then 'alarm'\n      when max(status) = 1 then 'skip'\n      when max(status) = 0 then 'ok'\n    end as status,\n    case\n      when max(status) = 2 then 'IAM Access analyzer is not enabled for this account on regions: [' || string_agg(region, ',') || ']' \n      when max(status) = 1 then 'Account is not opted in regions: [' || string_agg(region, ',') || ']'\n      when max(status) = 0 then 'IAM Access analyzer is enabled for this account on regions: [' || string_agg(region, ',') || ']'\n    end as reason\n  FROM regions\n  GROUP BY account_id, og_account_id\n)\nSELECT \n  r.resource AS resource,\n  r.og_account_id as og_account_id,\n  a.og_resource_id as og_resource_id,\n  r.status as status,\n  r.reason as reason\nFROM results as r JOIN aws_account as a ON r.og_account_id = a.og_account_id\n"
  PrimaryTable: aws_account
  ListOfTables:
    - aws_accessanalyzer_analyzer
    - aws_account
    - aws_region
  Parameters: []
Severity: high
Tags:
  category:
    - Compliance
  cis:
    - "true"
  cis_item_id:
    - "1.21"
  cis_level:
    - "1"
  cis_section_id:
    - "1"
  cis_type:
    - automated
  cis_version:
    - v1.3.0
  plugin:
    - aws
  service:
    - AWS/IAM
IntegrationTypeName:
  - aws_cloud_account
