Description: This control checks whether your S3 buckets allow public read access. It evaluates the Block Public Access settings, the bucket policy, and the bucket access control list (ACL).
ID: aws_foundational_security_s3_2
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables: []
  Parameters: []
  PrimaryTable: ""
  QueryToExecute: |
    WITH public_acl AS (
      SELECT
        DISTINCT name
      FROM
        aws_s3_bucket,
        jsonb_array_elements(acl -> 'Grants') AS grants
      WHERE
        (grants -> 'Grantee' ->> 'URI' = 'http://acs.amazonaws.com/groups/global/AllUsers'
        OR grants -> 'Grantee' ->> 'URI' = 'http://acs.amazonaws.com/groups/global/AuthenticatedUsers')
        AND (
          grants ->> 'Permission' = 'FULL_CONTROL'
          OR grants ->> 'Permission' = 'READ_ACP'
          OR grants ->> 'Permission' = 'READ'
        )
    ),
    read_access_policy AS (
      SELECT
        DISTINCT name
      FROM
        aws_s3_bucket,
        jsonb_array_elements(policy_std -> 'Statement') AS s,
        jsonb_array_elements_text(s -> 'Action') AS action
      WHERE
        s ->> 'Effect' = 'Allow'
        AND (
          s -> 'Principal' -> 'AWS' = '[\"*\"]'
          OR s ->> 'Principal' = '*'
        )
        AND (
          action = '*'
          OR action = '*:*'
          OR action = 's3:*'
          OR action ILIKE 's3:get%'
          OR action ILIKE 's3:list%'
        )
    )
    SELECT
      b.arn AS resource,
      CASE
        WHEN (block_public_acls OR a.name IS NULL) AND NOT bucket_policy_is_public THEN 'ok'
        WHEN (block_public_acls OR a.name IS NULL) AND (bucket_policy_is_public AND block_public_policy) THEN 'ok'
        WHEN (block_public_acls OR a.name IS NULL) AND (bucket_policy_is_public AND p.name IS NULL) THEN 'ok'
        ELSE 'alarm'
      END AS status,
      CASE
        WHEN (block_public_acls OR a.name IS NULL) AND NOT bucket_policy_is_public THEN b.title || ' not publicly readable.'
        WHEN (block_public_acls OR a.name IS NULL) AND (bucket_policy_is_public AND block_public_policy) THEN b.title || ' not publicly readable.'
        WHEN (block_public_acls OR a.name IS NULL) AND (bucket_policy_is_public AND p.name IS NULL) THEN  b.title || ' not publicly readable.'
        ELSE b.title || ' publicly readable.'
      END AS reason
    FROM
      aws_s3_bucket AS b
      LEFT JOIN public_acl AS a ON b.name = a.name
      LEFT JOIN read_access_policy AS p ON b.name = p.name;
Severity: critical
Tags: {}
Title: 2 S3 buckets should prohibit public read access