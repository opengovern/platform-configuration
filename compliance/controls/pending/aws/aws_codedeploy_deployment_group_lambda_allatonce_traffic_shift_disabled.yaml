Description: This control checks if the deployment group for Lambda Compute Platform is not using the default deployment configuration. The rule is non-compliant if the deployment group is using the deployment configuration 'CodeDeployDefault.LambdaAllAtOnce'.
ID: aws_codedeploy_deployment_group_lambda_allatonce_traffic_shift_disabled
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables: []
  Parameters: []
  PrimaryTable: ""
  QueryToExecute: |
    WITH codedeployment_groups AS (
      SELECT
        arn,
        application_name,
        deployment_config_name,
        tags,
        title,
        region,
        account_id,
        _ctx
      FROM
        aws_codedeploy_deployment_group
      GROUP BY
        arn,
        application_name,
        deployment_config_name,
        tags,
        title,
        region,
        account_id,
        _ctx
    ),
    codedeploy_apps AS (
      SELECT
        application_name,
        compute_platform,
        region,
        account_id,
        title
      FROM
        aws_codedeploy_app
      GROUP BY
        application_name,
        compute_platform,
        region,
        account_id,
        title
    )
    SELECT
      g.arn AS resource,
      CASE
        WHEN a.compute_platform <> 'Lambda' THEN 'skip'
        WHEN deployment_config_name = 'CodeDeployDefault.LambdaAllAtOnce' THEN 'alarm'
        ELSE 'ok'
      END AS status,
      CASE
        WHEN a.compute_platform <> 'Lambda' THEN g.title || ' using ' || a.compute_platform || ' compute platform.'
        ELSE g.title || ' using ' || deployment_config_name || ' deployment config.'
      END AS reason
    FROM
      codedeployment_groups AS g,
      codedeploy_apps AS a
    WHERE
      g.application_name = a.application_name;
Severity: low
Tags: {}
Title: Codedeploy deployment groups lambda allatonce traffic shift should be disabled