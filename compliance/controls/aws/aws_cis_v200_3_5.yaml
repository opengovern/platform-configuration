Description: AWS Config is a web service that performs configuration management of supported AWS resources within your account and delivers log files to you. The recorded information includes the configuration item (AWS resource), relationships between configuration items (AWS resources), any configuration changes between resources. It is recommended AWS Config be enabled in all regions.
ID: aws_cis_v200_3_5
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables:
    - aws_config_configuration_recorder
    - aws_region
  Parameters: []
  PrimaryTable: aws_config_configuration_recorder
  QueryToExecute: |
    WITH global_recorders AS (
      SELECT
        COUNT(*) AS global_config_recorders
      FROM
        aws_config_configuration_recorder
      WHERE
        recording_group -> 'IncludeGlobalResourceTypes' = 'true'
        AND recording_group -> 'AllSupported' = 'true'
        AND status ->> 'Recording' = 'true'
        AND status ->> 'LastStatus' = 'SUCCESS'
    )
    SELECT
      'arn:aws::' || a.region || ':' || a.account_id AS resource,
      a.og_account_id AS og_account_id,
      a.og_resource_id AS og_resource_id,
      CASE
        WHEN g.global_config_recorders >= 1
        AND status ->> 'Recording' = 'true'
        AND status ->> 'LastStatus' = 'SUCCESS'
        THEN 'ok'
        WHEN a.opt_in_status = 'not-opted-in'
        THEN 'skip'
        ELSE 'alarm'
      END AS status,
      CASE
        WHEN a.opt_in_status = 'not-opted-in'
        THEN a.region || ' region is disabled.'
        ELSE
          CASE
            WHEN recording_group -> 'IncludeGlobalResourceTypes' = 'true'
            THEN a.region || ' IncludeGlobalResourceTypes enabled,'
            ELSE a.region || ' IncludeGlobalResourceTypes disabled,'
          END ||
          CASE
            WHEN recording_group -> 'AllSupported' = 'true'
            THEN ' AllSupported enabled,'
            ELSE ' AllSupported disabled,'
          END ||
          CASE
            WHEN status ->> 'Recording' = 'true'
            THEN ' Recording enabled'
            ELSE ' Recording disabled'
          END ||
          CASE
            WHEN status ->> 'LastStatus' = 'SUCCESS'
            THEN ' and LastStatus is SUCCESS.'
            ELSE ' and LastStatus is not SUCCESS.'
          END
      END AS reason
    FROM
      global_recorders AS g,
      aws_region AS a
    LEFT JOIN
      aws_config_configuration_recorder AS r
      ON r.account_id = a.account_id
      AND r.region = a.name
Severity: low
Tags: {}
Title: 3.5 Ensure AWS Config is enabled in all regions