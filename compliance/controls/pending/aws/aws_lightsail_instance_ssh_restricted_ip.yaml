Description: Any ports enable within Lightsail by default are open and exposed to the world. For SSH and RDP access you should identify which IP address need access.
ID: aws_lightsail_instance_ssh_restricted_ip
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables: []
  Parameters: []
  PrimaryTable: ""
  QueryToExecute: |
    WITH open_ports AS (
      SELECT
        name,
        jsonb_array_elements(networking -> 'Ports') AS port
      FROM
        aws_lightsail_instance
    ),
    port_cidrs AS (
      SELECT
        op.name,
        (op.port ->> 'FromPort')::int AS from_port,
        (op.port ->> 'ToPort')::int AS to_port,
        op.port ->> 'Protocol' AS protocol,
        jsonb_array_elements_text(op.port -> 'Cidrs') AS cidr
      FROM
        open_ports op
    ),
    unrestricted_ssh_ports AS (
      SELECT
        name
      FROM
        port_cidrs
      WHERE
        from_port = 22
        AND to_port = 22
        AND protocol = 'tcp'
        AND cidr = '0.0.0.0/0'
    )
    SELECT
      i.name AS resource,
      CASE
        WHEN usp.name IS NULL THEN 'ok'
        ELSE 'alarm'
      END AS status,
      CASE
        WHEN usp.name IS NULL THEN i.name || ' has SSH (22) restricted to specific IP addresses.'
        ELSE i.name || ' has SSH (22) open to the world (0.0.0.0/0).'
      END AS reason,
      i.tags
    FROM
      aws_lightsail_instance i
        LEFT JOIN unrestricted_ssh_ports usp ON i.name = usp.name;
Severity: low
Tags: {}
Title: Ensure SSH is restricted to only IP address that should have this access