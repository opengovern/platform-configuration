Description: This control checks whether logging is enabled with the minimum severity level of LOGGER_SEVERITY_DEFAULT for DMS replication tasks TARGET_APPLY and TARGET_LOAD. The control fails if logging isn't enabled for these tasks or if the minimum severity level is less than LOGGER_SEVERITY_DEFAULT.
ID: aws_dms_replication_task_target_database_logging_enabled
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables: []
  Parameters: []
  PrimaryTable: ""
  QueryToExecute: |
    WITH replication_task_target_apply AS (
      SELECT
        arn
      FROM
        aws_dms_replication_task,
        jsonb_array_elements(replication_task_settings -> 'Logging' -> 'LogComponents') AS o
      WHERE
        o ->> 'Id' = 'TARGET_APPLY'
        AND o ->> 'Severity' IN ('LOGGER_SEVERITY_DEFAULT', 'LOGGER_SEVERITY_DEBUG', 'LOGGER_SEVERITY_DETAILED_DEBUG')
    ), replication_task_target_load AS (
      SELECT
        arn
      FROM
        aws_dms_replication_task,
        jsonb_array_elements(replication_task_settings -> 'Logging' -> 'LogComponents') AS o
      WHERE
        o ->> 'Id' = 'TARGET_LOAD'
        AND o ->> 'Severity' IN ('LOGGER_SEVERITY_DEFAULT', 'LOGGER_SEVERITY_DEBUG', 'LOGGER_SEVERITY_DETAILED_DEBUG')
    )
    SELECT
      t.arn AS resource,
      (replication_task_settings -> 'Logging' ->> 'EnableLogging')::bool,
      CASE
        WHEN (replication_task_settings -> 'Logging' ->> 'EnableLogging')::bool
          AND a.arn IS NOT NULL
          AND l.arn IS NOT NULL THEN 'ok'
        ELSE 'alarm'
      END AS status,
      CASE
        WHEN (replication_task_settings -> 'Logging' ->> 'EnableLogging')::bool
          AND a.arn IS NOT NULL
          AND l.arn IS NOT NULL THEN title || ' target database logging enabled.'
        ELSE title || 'target database logging disabled.'
      END AS reason
    FROM
      aws_dms_replication_task AS t
    LEFT JOIN replication_task_target_apply AS a ON a.arn = t.arn
    LEFT JOIN replication_task_target_load AS l ON l.arn = t.arn;
Severity: low
Tags: {}
Title: DMS replication tasks for the target database should have logging enabled