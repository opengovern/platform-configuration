Description: Manage access to resources in the AWS Cloud by only allowing authorized users, processes, and devices access to AWS Simple Storage Service (AWS S3) buckets.
ID: aws_s3_bucket_restrict_public_write_access
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables:
    - aws_s3_bucket
  Parameters: []
  PrimaryTable: aws_s3_bucket
  QueryToExecute: |
    WITH public_acl AS (
      SELECT DISTINCT name
      FROM aws_s3_bucket,
           jsonb_array_elements(CASE jsonb_typeof(acl -> 'Grants')
              WHEN 'array' THEN acl -> 'Grants'
              ELSE '[]' END) AS grants
      WHERE (grants -> 'Grantee' ->> 'URI' = 'http://acs.amazonaws.com/groups/global/AllUsers'
             OR grants -> 'Grantee' ->> 'URI' = 'http://acs.amazonaws.com/groups/global/AuthenticatedUsers')
        AND (grants ->> 'Permission' = 'FULL_CONTROL'
             OR grants ->> 'Permission' = 'WRITE_ACP'
             OR grants ->> 'Permission' = 'WRITE')
    ),
    write_access_policy AS (
      SELECT DISTINCT name
      FROM aws_s3_bucket,
           jsonb_array_elements(CASE jsonb_typeof(policy_std -> 'Statement')
              WHEN 'array' THEN policy_std -> 'Statement'
              ELSE '[]' END) AS s,
           jsonb_array_elements_text(CASE jsonb_typeof(s -> 'Action')
              WHEN 'array' THEN s -> 'Action'
              ELSE '[]' END) AS action
      WHERE s ->> 'Effect' = 'Allow'
        AND (s -> 'Principal' -> 'AWS' = '[\"*\"]'
             OR s ->> 'Principal' = '*')
        AND (action = '*'
             OR action = '*:*'
             OR action = 's3:*'
             OR action ILIKE 's3:put%'
             OR action ILIKE 's3:delete%'
             OR action ILIKE 's3:create%'
             OR action ILIKE 's3:update%'
             OR action ILIKE 's3:replicate%'
             OR action ILIKE 's3:restore%')
    )
    SELECT b.arn AS resource,
           b.og_account_id AS og_account_id,
           b.og_resource_id AS og_resource_id,
           CASE
             WHEN (block_public_acls OR a.name IS NULL) AND NOT bucket_policy_is_public THEN 'ok'
             WHEN (block_public_acls OR a.name IS NULL) AND (bucket_policy_is_public AND block_public_policy) THEN 'ok'
             WHEN bucket_policy_is_public AND p.name IS NULL THEN 'ok'
             ELSE 'alarm'
           END AS status,
           CASE
             WHEN (block_public_acls OR a.name IS NULL) AND NOT bucket_policy_is_public THEN b.title || ' not publicly writable.'
             WHEN (block_public_acls OR a.name IS NULL) AND (bucket_policy_is_public AND block_public_policy) THEN b.title || ' not publicly writable.'
             WHEN (block_public_acls OR a.name IS NULL) AND (bucket_policy_is_public AND p.name IS NULL) THEN b.title || ' not publicly writable.'
             ELSE b.title || ' publicly writable.'
           END AS reason,
           b.region,
           b.account_id
    FROM aws_s3_bucket AS b
         LEFT JOIN public_acl AS a ON b.name = a.name
         LEFT JOIN write_access_policy AS p ON b.name = p.name;
Severity: high
Tags:
  audit_manager_control_tower:
    - "true"
  category:
    - Compliance
  cis_controls_v8_ig1:
    - "true"
  cisa_cyber_essentials:
    - "true"
  fedramp_low_rev_4:
    - "true"
  fedramp_moderate_rev_4:
    - "true"
  ffiec:
    - "true"
  gxp_21_cfr_part_11:
    - "true"
  hipaa_final_omnibus_security_rule_2013:
    - "true"
  hipaa_security_rule_2003:
    - "true"
  nist_800_53_rev_4:
    - "true"
  nist_800_53_rev_5:
    - "true"
  nist_800_171_rev_2:
    - "true"
  nist_csf:
    - "true"
  pci_dss_v321:
    - "true"
  plugin:
    - aws
  rbi_cyber_security:
    - "true"
  service:
    - AWS/S3
  soc_2:
    - "true"
Title: S3 buckets should prohibit public write access