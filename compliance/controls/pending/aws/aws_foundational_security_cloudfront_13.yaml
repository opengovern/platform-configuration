Description: This control checks whether an Amazon CloudFront distribution with an Amazon S3 origin has origin access control (OAC) configured. The control fails if OAC isn't configured for the CloudFront distribution.
ID: aws_foundational_security_cloudfront_13
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables: []
  Parameters: []
  PrimaryTable: ""
  QueryToExecute: |
    SELECT
      arn AS resource,
      CASE
        WHEN o ->> 'DomainName' NOT LIKE '%s3.amazonaws.com' THEN 'skip'
        WHEN o ->> 'DomainName' LIKE '%s3.amazonaws.com'
          AND o -> 'S3OriginConfig' ->> 'OriginAccessIdentity' = '' THEN 'alarm'
        ELSE 'ok'
      END AS status,
      CASE
        WHEN o ->> 'DomainName' NOT LIKE '%s3.amazonaws.com' THEN title || ' origin type is not s3.'
        WHEN o ->> 'DomainName' LIKE '%s3.amazonaws.com'
          AND o -> 'S3OriginConfig' ->> 'OriginAccessIdentity' = '' THEN title || ' origin access identity not configured.'
        ELSE title || ' origin access identity configured.'
      END AS reason
    FROM
      aws_cloudfront_distribution,
      jsonb_array_elements(origins) AS o;
Severity: medium
Tags: {}
Title: 13 CloudFront distributions should use origin access control