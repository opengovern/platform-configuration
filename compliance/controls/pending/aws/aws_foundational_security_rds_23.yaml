Description: This control checks whether the RDS cluster or instance uses a port other than the default port of the database engine.
ID: aws_foundational_security_rds_23
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables: []
  Parameters: []
  PrimaryTable: ""
  QueryToExecute: |
    (
      SELECT
        arn AS resource,
        CASE
          WHEN engine SIMILAR TO '%(aurora|mysql|mariadb)%' AND port = '3306' THEN 'alarm'
          WHEN engine LIKE '%postgres%' AND port = '5432' THEN 'alarm'
          WHEN engine LIKE 'oracle%' AND port = '1521' THEN 'alarm'
          WHEN engine LIKE 'sqlserver%' AND port = '1433' THEN 'alarm'
          ELSE 'ok'
        END AS status,
        CASE
          WHEN engine SIMILAR TO '%(aurora|mysql|mariadb)%' AND port = '3306' THEN title || ' ' || engine || ' uses a default port.'
          WHEN engine LIKE '%postgres%' AND port = '5432' THEN title || ' ' || engine || ' uses a default port.'
          WHEN engine LIKE 'oracle%' AND port = '1521' THEN title || ' ' || engine || ' uses a default port.'
          WHEN engine LIKE 'sqlserver%' AND port = '1433' THEN title || ' ' || engine || ' uses a default port.'
          ELSE title || ' doesn\'t use a default port.'
        END AS reason
      FROM
        aws_rds_db_cluster
    )
    UNION
    (
      SELECT
        arn AS resource,
        CASE
          WHEN engine SIMILAR TO '%(aurora|mysql|mariadb)%' AND port = '3306' THEN 'alarm'
          WHEN engine LIKE '%postgres%' AND port = '5432' THEN 'alarm'
          WHEN engine LIKE 'oracle%' AND port = '1521' THEN 'alarm'
          WHEN engine LIKE 'sqlserver%' AND port = '1433' THEN 'alarm'
          ELSE 'ok'
        END AS status,
        CASE
          WHEN engine SIMILAR TO '%(aurora|mysql|mariadb)%' AND port = '3306' THEN title || ' ' || engine || ' uses a default port.'
          WHEN engine LIKE '%postgres%' AND port = '5432' THEN title || ' ' || engine || ' uses a default port.'
          WHEN engine LIKE 'oracle%' AND port = '1521' THEN title || ' ' || engine || ' uses a default port.'
          WHEN engine LIKE 'sqlserver%' AND port = '1433' THEN title || ' ' || engine || ' uses a default port.'
          ELSE title || ' doesn\'t use a default port.'
        END AS reason
      FROM
        aws_rds_db_instance
    );
Severity: low
Tags: {}
Title: 23 RDS databases and clusters should not use a database engine default port