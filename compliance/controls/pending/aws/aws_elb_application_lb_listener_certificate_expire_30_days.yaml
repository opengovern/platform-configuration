Description: This control ensures that SSL/TLS certificates used in application load balancers are renewed 30 days before their expiration date.
ID: aws_elb_application_lb_listener_certificate_expire_30_days
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables: []
  Parameters: []
  PrimaryTable: ""
  QueryToExecute: |
    SELECT
      load_balancer_arn AS resource,
      CASE
        WHEN DATE(not_after) - DATE(current_date) >= 30 THEN 'ok'
        ELSE 'alarm'
      END AS status,
      l.title || ' certificate set to expire in ' || EXTRACT(DAY FROM not_after - current_date) || ' days.' AS reason
    FROM
      aws_ec2_load_balancer_listener AS l,
      jsonb_array_elements(certificates) AS c
    LEFT JOIN aws_acm_certificate AS a
      ON c ->> 'CertificateArn' = a.certificate_arn;
Severity: low
Tags: {}
Title: ELB application load balancers secured listener certificate should not expire within next 30 days