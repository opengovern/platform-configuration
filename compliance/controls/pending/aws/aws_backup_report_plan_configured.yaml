Description: Ensure that there is a minimum of one backup report plan in each region. The rule will be considered non-compliant if a region with backup plans does not have any backup report plans.
ID: aws_backup_report_plan_configured
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables: []
  Parameters: []
  PrimaryTable: ""
  QueryToExecute: |
    WITH backup_plan_configured_regions AS (
      SELECT
        DISTINCT region,
        account_id
      FROM
        aws_backup_plan
      GROUP BY
        region,
        account_id
    ), backup_report_plan_configured AS (
      SELECT
        DISTINCT region,
        account_id
      FROM
        aws_backup_report_plan
      GROUP BY
        region,
        account_id
    )
    SELECT
      'arn:' || r.partition || '::' || r.region || ':' || r.account_id AS resource,
      CASE
        WHEN cp.region IS NOT NULL AND rp.region IS NOT NULL THEN 'ok'
        WHEN cp.region IS NOT NULL AND rp.region IS NULL THEN 'alarm'
        ELSE 'info'
      END AS status,
      CASE
        WHEN cp.region IS NOT NULL AND rp.region IS NOT NULL THEN 'Backup report plan(s) exist in region ' || r.region || '.'
        WHEN cp.region IS NOT NULL AND rp.region IS NULL THEN 'No backup report plan(s) exist in region ' || r.region || '.'
        ELSE 'No backup plan(s) configured in region ' || r.region || '.'
      END AS reason
    FROM
      aws_region AS r
      LEFT JOIN backup_plan_configured_regions AS cp ON r.account_id = cp.account_id AND r.region = cp.region
      LEFT JOIN backup_report_plan_configured AS rp ON r.account_id = rp.account_id AND r.region = rp.region;
Severity: low
Tags: {}
Title: Backup report plan should exist in a region where backup plan is enabled