Description: This control checks whether an AWS Secrets Manager secret rotated successfully based on the rotation schedule. The control fails if RotationOccurringAsScheduled is false. The control does not evaluate secrets that do not have rotation configured.
ID: aws_foundational_security_secretsmanager_2
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables:
    - aws_secretsmanager_secret
  Parameters: []
  PrimaryTable: aws_secretsmanager_secret
  QueryToExecute: |
    SELECT
      arn AS resource,
      og_account_id AS og_account_id,
      og_resource_id AS og_resource_id,
      CASE
        WHEN primary_region IS NOT NULL AND region != primary_region THEN 'skip'
        WHEN rotation_rules IS NULL THEN 'alarm'
        WHEN last_rotated_date IS NULL
          AND (DATE(current_date) - DATE(created_date)) <= (rotation_rules -> 'AutomaticallyAfterDays')::integer THEN 'ok'
        WHEN last_rotated_date IS NULL
          AND (DATE(current_date) - DATE(created_date)) > (rotation_rules -> 'AutomaticallyAfterDays')::integer THEN 'alarm'
        WHEN last_rotated_date IS NOT NULL
          AND (DATE(current_date) - DATE(last_rotated_date)) > (rotation_rules -> 'AutomaticallyAfterDays')::integer THEN 'alarm'
      END AS status,
      CASE
        WHEN primary_region IS NOT NULL AND region != primary_region THEN title || ' is a replica.'
        WHEN rotation_rules IS NULL THEN title || ' rotation not enabled.'
        WHEN last_rotated_date IS NULL
          AND (DATE(current_date) - DATE(created_date)) <= (rotation_rules -> 'AutomaticallyAfterDays')::integer THEN title || ' scheduled for rotation.'
        WHEN last_rotated_date IS NULL
          AND (DATE(current_date) - DATE(created_date)) > (rotation_rules -> 'AutomaticallyAfterDays')::integer THEN title || ' not rotated as per schedule.'
        WHEN last_rotated_date IS NOT NULL
          AND (DATE(current_date) - DATE(last_rotated_date)) > (rotation_rules -> 'AutomaticallyAfterDays')::integer THEN title || ' not rotated as per schedule.'
      END AS reason
    FROM
      aws_secretsmanager_secret;
Severity: medium
Tags: {}
Title: 2 Secrets Manager secrets configured with automatic rotation should rotate successfully