Description: Any ports enabled within Lightsail by default are open and exposed to the world. For SSH and RDP access you should identify which IP address need access.
ID: aws_lightsail_instance_rdp_restricted_ip
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables: []
  Parameters: []
  PrimaryTable: ""
  QueryToExecute: |
    WITH open_ports AS (
      SELECT
        name,
        jsonb_array_elements(networking -> 'Ports') AS port
      FROM
        aws_lightsail_instance
    ),
    port_cidrs AS (
      SELECT
        op.name,
        (op.port ->> 'FromPort')::INT AS from_port,
        (op.port ->> 'ToPort')::INT AS to_port,
        op.port ->> 'Protocol' AS protocol,
        jsonb_array_elements_text(op.port -> 'Cidrs') AS cidr
      FROM
        open_ports op
    ),
    unrestricted_rdp_ports AS (
      SELECT
        name
      FROM
        port_cidrs
      WHERE
        from_port = 3389
        AND to_port = 3389
        AND protocol = 'tcp'
        AND cidr = '0.0.0.0/0'
    )
    SELECT
      i.name AS resource,
      CASE
        WHEN urp.name IS NULL THEN 'ok'
        ELSE 'alarm'
      END AS status,
      CASE
        WHEN urp.name IS NULL THEN i.name || ' has RDP (3389) restricted to specific IP addresses.'
        ELSE i.name || ' has RDP (3389) open to the world (0.0.0.0/0).'
      END AS reason,
      i.tags
    FROM
      aws_lightsail_instance i
      LEFT JOIN unrestricted_rdp_ports urp ON i.name = urp.name;
Severity: low
Tags: {}
Title: Ensure RDP is restricted to only IP address that should have this access