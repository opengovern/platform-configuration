Description: This control checks whether the Lambda function resource-based policy prohibits public access outside of your account. The Lambda function should not be publicly accessible, as this may allow unintended access to your code stored in the function.
ID: aws_foundational_security_lambda_1
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables:
    - aws_lambda_function
  Parameters: []
  PrimaryTable: aws_lambda_function
  QueryToExecute: |
    WITH wildcard_action_policies AS (
      SELECT
        arn,
        COUNT(*) AS statements_num
      FROM
        aws_lambda_function,
        jsonb_array_elements(policy_std -> 'Statement') AS s
      WHERE
        s ->> 'Effect' = 'Allow'
        AND (
          (s -> 'Principal' -> 'AWS') = '[\"*\"]'
          OR s ->> 'Principal' = '*'
        )
      GROUP BY
        arn
    )
    SELECT
      f.arn AS resource,
      f.og_account_id AS og_account_id,
      f.og_resource_id AS og_resource_id,
      CASE
        WHEN p.arn IS NULL THEN 'ok'
        ELSE 'alarm'
      END AS status,
      CASE
        WHEN p.arn IS NULL THEN title || ' does not allow public access.'
        ELSE title || ' contains ' || COALESCE(p.statements_num, 0) || ' statements that allows public access.'
      END AS reason
    FROM
      aws_lambda_function AS f
    LEFT JOIN wildcard_action_policies AS p
      ON p.arn = f.arn
Severity: critical
Tags: {}
Title: 1 Lambda function policies should prohibit public access