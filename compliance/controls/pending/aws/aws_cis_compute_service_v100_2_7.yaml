Description: When an EC2 instance is launched a specified custom security group should be assigned to the instance.
ID: aws_cis_compute_service_v100_2_7
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables: []
  Parameters: []
  PrimaryTable: ""
  QueryToExecute: |
    SELECT
      arn AS resource,
      CASE
        WHEN jsonb_array_length(ip_permissions) = 0 AND jsonb_array_length(ip_permissions_egress) = 0 THEN 'ok'
        ELSE 'alarm'
      END AS status,
      CASE
        WHEN jsonb_array_length(ip_permissions) > 0 AND jsonb_array_length(ip_permissions_egress) > 0
          THEN 'Default security group ' || group_id || ' has inbound and outbound rules.'
        WHEN jsonb_array_length(ip_permissions) > 0 AND jsonb_array_length(ip_permissions_egress) = 0
          THEN 'Default security group ' || group_id || ' has inbound rules.'
        WHEN jsonb_array_length(ip_permissions) = 0 AND jsonb_array_length(ip_permissions_egress) > 0
          THEN 'Default security group ' || group_id || ' has outbound rules.'
        ELSE 'Default security group ' || group_id || ' has no inbound or outbound rules.'
      END AS reason
    FROM
      aws_vpc_security_group
    WHERE
      group_name = 'default';
Severity: low
Tags: {}
Title: 2.7 Ensure Default EC2 Security groups are not being used