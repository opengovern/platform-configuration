ID: azure_compute_vm_vulnerability_assessment_solution_enabled
Title: "A vulnerability assessment solution should be enabled on your virtual machines"
Description: "Audits virtual machines to detect whether they are running a supported vulnerability assessment solution. A core component of every cyber risk and security program is the identification and analysis of vulnerabilities. Azure Security Center's standard pricing tier includes vulnerability scanning for your virtual machines at no extra cost. Additionally, Security Center can automatically deploy this tool for you."
Query:
  Engine: CloudQL-v0.0.1
  QueryToExecute: "with defender_enabled_vms as (\n  select\n    distinct a.vm_id as vm_id\n  from\n    azure_compute_virtual_machine as a,\n    jsonb_array_elements(extensions) as b\n  where\n    b ->> 'ExtensionType' = any(ARRAY ['MDE.Linux', 'MDE.Windows'])\n    and b ->> 'ProvisioningState' = 'Succeeded'\n),\nagent_installed_vm as (\n  select\n    distinct a.vm_id as vm_id\n  from\n    defender_enabled_vms as a\n    left join azure_compute_virtual_machine as w on w.vm_id = a.vm_id,\n    jsonb_array_elements(extensions) as b\n  where\n    b ->> 'Publisher' = 'Qualys'\n    and b ->> 'ExtensionType' = any(ARRAY ['WindowsAgent.AzureSecurityCenter', 'LinuxAgent.AzureSecurityCenter'])\n    and b ->> 'ProvisioningState' = 'Succeeded'\n)\nselect\n  a.vm_id as resource,\n  a.og_account_id as og_account_id,\n  a.og_resource_id as og_resource_id,\n  case\n    when b.vm_id is not null then 'ok'\n    else 'alarm'\n  end as status,\n  case\n    when b.vm_id is not null then a.title || ' have vulnerability assessment solution enabled.'\n    else a.title || ' have vulnerability assessment solution disabled.'\n  end as reason\n  \n  , a.resource_group as resource_group\n  , sub.display_name as subscription\nfrom\n  azure_compute_virtual_machine as a\n  left join agent_installed_vm as b on a.vm_id = b.vm_id,\n  azure_subscription as sub\nwhere\n  sub.subscription_id = a.subscription_id;\n"
  PrimaryTable: azure_compute_virtual_machine
  ListOfTables:
    - azure_compute_virtual_machine
    - azure_subscription
  Parameters: []
Severity: medium
Tags:
  hipaa_hitrust_v92:
    - "true"
  nist_sp_800_53_rev_5:
    - "true"
  pci_dss_v321:
    - "true"
  service:
    - Azure/Compute
IntegrationType:
  - azure_subscription
