ID: azure_use_network_contributor_role_for_managing_azure_network_resources
Title: "Use Network Contributor Role for Managing Azure Network Resources"
Description: "Ensure that AKS clusters are configured to use the Network Contributor role."
Query:
  Engine: odysseus-v0.0.1
  QueryToExecute: "with rd as (\n  select\n    scope, ARRAY_AGG(role_name) as roles\n  from\n    azure_role_assignment as ra left join azure_role_definition as rd on ra.role_definition_id = rd.id\n  group by scope limit 10\n)\n  \nselect\n  c.name as resource,\n  c.og_resource_id,\n  c.og_account_id,\n  case\n    when rd.roles::text ilike '%Network Contributor%' then 'ok'\n    else 'alarm'\n  end as status,\n  case\n    when rd.roles::text ilike '%Network Contributor%' then c.name || ' is using a Network Contributor role to manage network resources.'\n    else c.name || ' is not using a Network Contributor role to manage network resources.'\n  end as reason,\n    c.resource_group as resource_group,\n    sub.display_name as subscription\n  from\n  azure_kubernetes_cluster as c\n    left join azure_subscription as sub on c.subscription_id = sub.subscription_id\n    left join rd as rd on c.id like '%' || rd.scope || '%'\n"
  PrimaryTable: azure_kubernetes_cluster
  ListOfTables:
    - azure_kubernetes_cluster
    - azure_role_assignment
    - azure_role_definition
    - azure_subscription
  Parameters: []
Severity: medium
Tags:
  platform_score_cloud_service_name:
    - Azure Kubernetes (AKS)
  score_service_name:
    - Azure Kubernetes (AKS)
IntegrationType:
  - azure_subscription
