ID: aws_attach_policy_to_iam_roles_associated_with_app_tier_ec2_instances
Title: "Attach Policy to IAM Roles Associated with App-Tier EC2 Instances"
Description: "Ensure IAM policy for EC2 IAM roles for app tier is configured."
Query:
  Engine: CloudQL-v0.0.1
  QueryToExecute: "select\n  instance_id as resource,\n  i.og_account_id,\n  i.og_resource_id,\n  case\n    when r.inline_policies is null and r.attached_policy_arns is null then 'alarm'\n    else 'ok'\n  end as status,\n  case\n    when i.iam_instance_profile_arn is null then instance_id || ' has no role attached'\n    when r.inline_policies is null and r.attached_policy_arns is null then instance_id || ' role does not have any policy'\n    else instance_id || ' role has policy'\n  end as reason,\n  i.region, \n  i.account_id\nfrom\n  aws_ec2_instance as i\n  left join aws_iam_role as r on split_part(i.iam_instance_profile_arn, ':instance-profile/', 2) = r.name\nwhere\n  i.tags::text like '%' || REPLACE(REPLACE((\n      SELECT jsonb_object_agg(key, value)::text\n      FROM jsonb_each_text('{{.awsAppTierTags}}'::jsonb)\n    ), '{', ''), '}', '') || '%'\n"
  PrimaryTable: aws_ec2_instance
  ListOfTables:
    - aws_ec2_instance
    - aws_iam_role
  Parameters:
    - Key: awsAppTierTags
      Required: true
Severity: medium
Tags:
  platform_score_cloud_service_name:
    - AWS Identity and Access Management (IAM)
  platform_score_use_case:
    - Problem Identities
  score_service_name:
    - AWS Identity and Access Management (IAM)
  score_tags:
    - Problem Identities
IntegrationType:
  - aws_cloud_account
