Description: This control checks whether logging is enabled with the minimum severity level of LOGGER_SEVERITY_DEFAULT for DMS replication tasks SOURCE_CAPTURE and SOURCE_UNLOAD. The control fails if logging isn't enabled for these tasks or if the minimum severity level is less than LOGGER_SEVERITY_DEFAULT.
ID: aws_dms_replication_task_source_database_logging_enabled
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables:
    - aws_dms_replication_task
  Parameters: []
  PrimaryTable: aws_dms_replication_task
  QueryToExecute: |
    WITH replication_task_logging AS (
      SELECT
        arn,
        og_account_id,
        og_resource_id,
        BOOL_OR(o ->> 'Id' = 'SOURCE_CAPTURE' AND o ->> 'Severity' IN ('LOGGER_SEVERITY_DEFAULT', 'LOGGER_SEVERITY_DEBUG', 'LOGGER_SEVERITY_DETAILED_DEBUG')) AS capture_logging_enabled,
        BOOL_OR(o ->> 'Id' = 'SOURCE_UNLOAD' AND o ->> 'Severity' IN ('LOGGER_SEVERITY_DEFAULT', 'LOGGER_SEVERITY_DEBUG', 'LOGGER_SEVERITY_DETAILED_DEBUG')) AS unload_logging_enabled
      FROM
        aws_dms_replication_task,
        JSONB_ARRAY_ELEMENTS(replication_task_settings -> 'Logging' -> 'LogComponents') AS o
      GROUP BY
        arn,
        og_account_id,
        og_resource_id
    )
  
    SELECT
      t.arn AS resource,
      t.og_account_id AS og_account_id,
      t.og_resource_id AS og_resource_id,
      (replication_task_settings -> 'Logging' ->> 'EnableLogging')::BOOL AS logging_enabled,
      CASE
        WHEN (replication_task_settings -> 'Logging' ->> 'EnableLogging')::BOOL AND l.capture_logging_enabled AND l.unload_logging_enabled THEN 'ok'
        ELSE 'alarm'
      END AS status,
      CASE
        WHEN (replication_task_settings -> 'Logging' ->> 'EnableLogging')::BOOL AND l.capture_logging_enabled AND l.unload_logging_enabled THEN title || ' source database logging enabled.'
        ELSE title || ' source database logging disabled.'
      END AS reason
    FROM
      aws_dms_replication_task AS t
      LEFT JOIN replication_task_logging AS l ON l.arn = t.arn;
Severity: low
Tags: {}
Title: DMS replication tasks for the source database should have logging enabled