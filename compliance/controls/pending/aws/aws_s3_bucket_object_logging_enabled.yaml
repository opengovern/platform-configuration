Description: Object-Level logging saves events in JSON format in CloudTrail. This is recommended from a security best practice perspective for buckets that contain sensitive data.
ID: aws_s3_bucket_object_logging_enabled
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables: []
  Parameters: []
  PrimaryTable: ""
  QueryToExecute: |
    WITH object_logging_cloudtrails AS (
      SELECT
        d ->> 'Type' AS type,
        REPLACE(REPLACE(v::text,'\"',''),'/','') AS bucket_arn
      FROM
        aws_cloudtrail_trail,
        jsonb_array_elements(event_selectors) e,
        jsonb_array_elements(e -> 'DataResources') AS d,
        jsonb_array_elements(d -> 'Values') v
      WHERE
        d ->> 'Type' = 'AWS::S3::Object'
    ),
    object_logging_region AS (
      SELECT
        region AS cloudtrail_region,
        REPLACE(REPLACE(v::text,'\"',''),'/','') AS bucket_arn
      FROM
        aws_cloudtrail_trail,
        jsonb_array_elements(event_selectors) e,
        jsonb_array_elements(e -> 'DataResources') AS d,
        jsonb_array_elements(d -> 'Values') v
      WHERE
        d ->> 'Type' = 'AWS::S3::Object'
        AND REPLACE(REPLACE(v::text,'\"',''),'/','') = 'arn:aws:s3'
      GROUP BY
        region,
        bucket_arn
    ),
    object_logging_region_advance_es AS (
      SELECT
        region AS cloudtrail_region
      FROM
        aws_cloudtrail_trail,
        jsonb_array_elements(advanced_event_selectors) a,
        jsonb_array_elements(a -> 'FieldSelectors') AS f,
        jsonb_array_elements_text(f -> 'Equals') e
      WHERE
        e = 'AWS::S3::Object'
        AND f ->> 'Field' != 'eventCategory'
      GROUP BY
        region
    )
    SELECT
      DISTINCT s.arn AS resource,
      CASE
        WHEN (s.arn = c.bucket_arn)
          OR (r.bucket_arn = 'arn:aws:s3' AND r.cloudtrail_region = s.region)
          OR a.cloudtrail_region = s.region THEN 'ok'
        ELSE 'alarm'
      END AS status,
      CASE
        WHEN (s.arn = c.bucket_arn)
          OR (r.bucket_arn = 'arn:aws:s3' AND r.cloudtrail_region = s.region)
          OR a.cloudtrail_region = s.region THEN s.name || ' object logging enabled.'
        ELSE s.name || ' object logging not enabled.'
      END AS reason
    FROM
      aws_s3_bucket AS s
      LEFT JOIN object_logging_cloudtrails AS c ON s.arn = c.bucket_arn
      LEFT JOIN object_logging_region AS r ON r.cloudtrail_region = s.region
      LEFT JOIN object_logging_region_advance_es AS a ON a.cloudtrail_region = s.region
Severity: low
Tags: {}
Title: S3 buckets object logging should be enabled