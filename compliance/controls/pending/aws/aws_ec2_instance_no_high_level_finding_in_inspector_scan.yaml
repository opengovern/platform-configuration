Description: AWS Inspector scans operating system packages installed on your AWS EC2 instances for vulnerabilities and network reachability issues. Each finding has the name of the detected vulnerability and provides a severity rating, information about the affected resource, and details such as how to remediate the reported vulnerability.
ID: aws_ec2_instance_no_high_level_finding_in_inspector_scan
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables: []
  Parameters: []
  PrimaryTable: ""
  QueryToExecute: |
    WITH severity_list AS (
      SELECT
        DISTINCT title,
        a ->> 'Value' AS instance_id
      FROM
        aws_inspector_finding,
        jsonb_array_elements(attributes) AS a
      WHERE
        severity = 'High'
        AND asset_type = 'ec2-instance'
        AND a ->> 'Key' = 'INSTANCE_ID'
      GROUP BY
        a ->> 'Value',
        title
    ),
    
    ec2_instance_list AS (
      SELECT
        DISTINCT instance_id
      FROM
        severity_list
    )
    
    SELECT
      arn AS resource,
      CASE
        WHEN l.instance_id IS NULL THEN 'ok'
        ELSE 'alarm'
      END AS status,
      CASE
        WHEN l.instance_id IS NULL THEN i.title || ' has no high level finding in inspector scans.'
        ELSE i.title || ' has ' || (SELECT COUNT(*) FROM severity_list WHERE instance_id = i.instance_id) || ' high level findings in inspector scans.'
      END AS reason
    FROM
      aws_ec2_instance AS i
    LEFT JOIN ec2_instance_list AS l ON i.instance_id = l.instance_id;
Severity: low
Tags: {}
Title: EC2 instances high level findings should not be there in inspector scans