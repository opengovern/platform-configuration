Description: Enable Secure Boot on supported Windows virtual machines to mitigate against malicious and unauthorized changes to the boot chain. Once enabled, only trusted bootloaders, kernel and kernel drivers will be allowed to run. This assessment applies to Trusted Launch and Confidential Windows virtual machines.
ID: azure_compute_windows_vm_secure_boot_enabled
IntegrationType:
  - azure_subscription
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables: []
  Parameters: []
  PrimaryTable: ""
  QueryToExecute: |
    SELECT
      a.id AS resource,
      CASE
        WHEN image_offer NOT LIKE '%Windows%' OR os_type NOT LIKE 'Windows%' THEN 'skip'
        WHEN security_profile ->> 'securityType' IN ('TrustedLaunch', 'ConfidentialVM') 
             AND security_profile ->> 'uefiSettings' IS NOT NULL 
             AND security_profile -> 'uefiSettings' ->> 'secureBootEnabled' = 'true' 
        THEN 'ok'
        ELSE 'alarm'
      END AS status,
      CASE
        WHEN image_offer NOT LIKE '%Windows%' OR os_type NOT LIKE 'Windows%' 
        THEN a.title || ' is not a Windows VM.'
        WHEN security_profile ->> 'securityType' IN ('TrustedLaunch', 'ConfidentialVM') 
             AND security_profile ->> 'uefiSettings' IS NOT NULL 
             AND security_profile -> 'uefiSettings' ->> 'secureBootEnabled' = 'true' 
        THEN a.title || ' secure boot enabled.'
        ELSE a.title || ' secure boot disabled.'
      END AS reason
    FROM
      azure_compute_virtual_machine AS a,
      azure_subscription AS sub
    WHERE
      sub.subscription_id = a.subscription_id
Severity: low
Tags: {}
Title: Secure Boot should be enabled on supported Windows virtual machines