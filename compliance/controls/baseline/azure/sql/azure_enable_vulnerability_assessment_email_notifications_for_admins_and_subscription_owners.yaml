Description: Ensure that the Vulnerability Assessment setting "Also send email notification to admins and subscription owners" is enabled for your Microsoft SQL database servers.
ID: azure_enable_vulnerability_assessment_email_notifications_for_admins_and_subscription_owners
IntegrationType:
  - azure_subscription
Query:
  Engine: odysseus-v0.0.1
  ListOfTables:
    - azure_sql_server
    - azure_subscription
  Parameters: []
  PrimaryTable: azure_sql_server
  QueryToExecute: |
    WITH sql_server_va AS (
      SELECT
        DISTINCT id
      FROM
        azure_sql_server AS s,
        JSONB_ARRAY_ELEMENTS(server_vulnerability_assessment) AS va
      WHERE
        va -> 'properties' -> 'recurringScans' ->> 'emailSubscriptionAdmins' = 'true'
    )
    SELECT
      name AS resource,
      s.platform_resource_id,
      s.platform_integration_id,
      CASE
        WHEN v.id IS NOT NULL THEN 'ok'
        ELSE 'alarm'
      END AS status,
      CASE
        WHEN v.id IS NOT NULL THEN 'Vulnerability Assessment Email Notifications is enabled'
        ELSE 'Vulnerability Assessment Email Notifications is not enabled'
      END AS reason
    FROM
      azure_sql_server AS s
      LEFT JOIN azure_subscription AS sub ON s.subscription_id = sub.subscription_id
      LEFT JOIN sql_server_va AS v ON LOWER(s.id) = LOWER(v.id)
Severity: medium
Tags:
  platform_score_cloud_service_name:
    - Azure Managed SQL Service
  platform_score_use_case:
    - Problem Identities
  score_service_name:
    - Azure Managed SQL Service
  score_tags:
    - Problem Identities
Title: Enable Vulnerability Assessment Email Notifications for Admins and Subscription Owners