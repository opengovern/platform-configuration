ID: azure_network_security_group_restrict_inbound_tcp_port_4333
Title: "Network security groups should restrict inbound TCP port 4333 access from internet"
Description: "Network security group provides stateful filtering of inbound/outbound network traffic to Azure resources. It is recommended that no network security group allows unrestricted inbound access to TCP port 4333."
Query:
  Engine: CloudQL-v0.0.1
  QueryToExecute: |
    WITH unrestricted_inbound AS (
      SELECT
        DISTINCT name AS sg_name
      FROM
        azure_network_security_group nsg,
        JSONB_ARRAY_ELEMENTS(security_rules || default_security_rules) sg,
        JSONB_ARRAY_ELEMENTS_TEXT(
          CASE
            WHEN jsonb_array_length(sg -> 'properties' -> 'destinationPortRanges') > 0 THEN (sg -> 'properties' -> 'destinationPortRanges')
            ELSE jsonb_build_array(sg -> 'properties' -> 'destinationPortRange')
          END) AS dport,
        JSONB_ARRAY_ELEMENTS_TEXT(
          CASE
            WHEN jsonb_array_length(sg -> 'properties' -> 'sourceAddressPrefixes') > 0 THEN (sg -> 'properties' -> 'sourceAddressPrefixes')
            ELSE jsonb_build_array(sg -> 'properties' -> 'sourceAddressPrefix')
          END) AS sip
      WHERE
        sg -> 'properties' ->> 'access' = 'Allow'
        AND sg -> 'properties' ->> 'direction' = 'Inbound'
        AND (sg -> 'properties' ->> 'protocol' ILIKE 'TCP' OR sg -> 'properties' ->> 'protocol' = '*')
        AND sip IN ('*', '0.0.0.0', '0.0.0.0/0', 'Internet', 'any', '<nw>/0', '/0')
        AND (
          dport IN ('4333', '*')
          OR (
            dport LIKE '%-%'
            AND (
              SPLIT_PART(dport, '-', 1)::integer = 4333
              AND SPLIT_PART(dport, '-', 2)::integer = 4333
            )
          )
        )
    )
    SELECT
      sg.id AS resource,
      sg.og_account_id AS og_account_id,
      sg.og_resource_id AS og_resource_id,
      CASE
        WHEN nsg.sg_name IS NULL THEN 'ok'
        ELSE 'alarm'
      END AS status,
      CASE
        WHEN nsg.sg_name IS NULL THEN sg.title || ' restricts TCP port 4333 access from internet.'
        ELSE sg.title || ' allows TCP port 4333 access from internet.'
      END AS reason
    FROM
      azure_network_security_group sg
      LEFT JOIN unrestricted_inbound nsg ON nsg.sg_name = sg.name
      JOIN azure_subscription sub ON sub.subscription_id = sg.subscription_id;
  PrimaryTable: azure_network_security_group
  ListOfTables:
    - azure_network_security_group
    - azure_subscription
  Parameters: []
Severity: low
Tags: {}
IntegrationType:
  - azure_subscription