Description: Ensure IAM Roles do not have ReadOnlyAccess access for external AWS account. The AWS-managed ReadOnlyAccess policy carries a high risk of potential data leakage, posing a significant threat to customer security and privacy.
ID: aws_iam_role_cross_account_read_only_access_policy
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables: []
  Parameters: []
  PrimaryTable: ""
  QueryToExecute: |
    WITH read_only_access_roles AS (
      SELECT
        *
      FROM
        aws_iam_role,
        jsonb_array_elements_text(attached_policy_arns) AS a
      WHERE
        a = 'arn:aws:iam::aws:policy/ReadOnlyAccess'
    ), read_only_access_roles_with_cross_account_access AS (
      SELECT
        arn
      FROM
        read_only_access_roles,
        jsonb_array_elements(assume_role_policy_std -> 'Statement') AS stmt,
        jsonb_array_elements_text(stmt -> 'Principal' -> 'AWS') AS p
      WHERE
        stmt ->> 'Effect' = 'Allow'
        AND (
          p = '*'
          OR NOT (p LIKE '%' || account_id || '%')
        )
    )
    SELECT
      r.arn AS resource,
      CASE
        WHEN ar.arn IS NULL THEN 'skip'
        WHEN c.arn IS NOT NULL THEN 'alarm'
        ELSE 'ok'
      END AS status,
      CASE
        WHEN ar.arn IS NULL THEN r.title || ' not associated with ReadOnlyAccess policy.'
        WHEN c.arn IS NOT NULL THEN r.title || ' associated with ReadOnlyAccess cross account access.'
        ELSE r.title || ' associated ReadOnlyAccess without cross account access.'
      END AS reason
    FROM
      aws_iam_role AS r
    LEFT JOIN
      read_only_access_roles AS ar ON r.arn = ar.arn
    LEFT JOIN
      read_only_access_roles_with_cross_account_access AS c ON c.arn = r.arn;
Severity: low
Tags: {}
Title: IAM roles should not have read only access for external AWS accounts