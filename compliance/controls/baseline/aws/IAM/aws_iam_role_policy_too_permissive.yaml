ID: aws_iam_role_policy_too_permissive
Title: "IAM Role Policy Too Permissive"
Description: "Ensure that the access policies attached to your IAM roles adhere to the principle of least privilege."
Query:
  Engine: CloudQL-v0.0.1
  QueryToExecute: "WITH too_permissive_policies AS (\n  SELECT\n    arn\n  FROM\n    aws_iam_policy,\n    jsonb_array_elements(policy_std -> 'Statement') AS s,\n    jsonb_array_elements_text(s -> 'Action') AS action\n  WHERE\n    action IN ('*', '*:*')\n    AND s ->> 'Effect' = 'Allow'\n)\n\nSELECT\n  name AS resource,\n  og_account_id,\n  og_resource_id,\n  CASE\n    WHEN EXISTS(\n      select 1 from jsonb_array_elements_text(attached_policy_arns) as parn\n        LEFT JOIN too_permissive_policies AS tp ON parn = tp.arn where tp.arn is not null\n    ) THEN 'alarm'\n    WHEN EXISTS(\n      SELECT 1 \n      FROM jsonb_array_elements(inline_policies_std) AS p, jsonb_array_elements(p -> 'PolicyDocument' -> 'Statement') AS s,\n        jsonb_array_elements_text(s -> 'Action') AS action\n      WHERE\n        action IN ('*', '*:*')\n        AND s ->> 'Effect' = 'Allow'\n    ) THEN 'alarm'\n    ELSE 'ok'\n  END AS status,\n  CASE\n    WHEN EXISTS(\n      select 1 from jsonb_array_elements_text(attached_policy_arns) as parn\n        LEFT JOIN too_permissive_policies AS tp ON parn = tp.arn where tp.arn is not null\n    ) THEN ' there is too permissive attached policy'\n    WHEN EXISTS(\n      SELECT 1 \n      FROM jsonb_array_elements(inline_policies_std) AS p, jsonb_array_elements(p -> 'PolicyDocument' -> 'Statement') AS s,\n        jsonb_array_elements_text(s -> 'Action') AS action\n      WHERE\n        action IN ('*', '*:*')\n        AND s ->> 'Effect' = 'Allow'\n    ) THEN ' there is too permissive inline policy'\n    ELSE 'there is no too permissive policy'\n  END AS reason,\n  region, \n  account_id\nFROM\n  aws_iam_role AS r\n"
  PrimaryTable: aws_iam_role
  ListOfTables:
    - aws_iam_policy
    - aws_iam_role
  Parameters: []
Severity: medium
Tags:
  platform_score_cloud_service_name:
    - AWS Identity and Access Management (IAM)
  platform_score_use_case:
    - Problem Identities
  score_service_name:
    - AWS Identity and Access Management (IAM)
  score_tags:
    - Problem Identities
Integration_Type_Name:
  - aws_cloud
