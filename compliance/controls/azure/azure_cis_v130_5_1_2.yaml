ID: azure_cis_v130_5_1_2
Title: "5.1.2 Ensure Diagnostic Setting captures appropriate categories"
Description: "Enable Diagnostic settings for exporting activity logs. Diagnostic setting are available for each individual resources within a subscription. Settings should be configured for all appropriate resources for your environment."
Query:
  Engine: CloudQL-v0.0.1
  QueryToExecute: "with enabled_settings as (\n  select\n    name,\n    id,\n    _ctx,\n    resource_group,\n    subscription_id,\n    count(*) filter (where l ->> 'enabled' = 'true'\n      and l ->> 'category' in ('Administrative', 'Security', 'Alert', 'Policy')\n    ) as valid_category_count,\n    string_agg(l ->> 'category', ', ') filter (where l ->> 'enabled' = 'true'\n      and l ->> 'category' in ('Administrative', 'Security', 'Alert', 'Policy')\n    ) as valid_categories\n  from\n    azure_diagnostic_setting,\n    jsonb_array_elements(logs) as l\n  group by\n    name,\n    id,\n    _ctx,\n    resource_group,\n    subscription_id\n)\nselect\n  sett.id as resource,\n  sett.og_account_id as og_account_id,\n  sett.og_resource_id as og_resource_id,\n  case\n    when valid_category_count = 4 then 'ok'\n    else 'alarm'\n  end as status,\n  case\n    when valid_category_count = 4\n      then name || ' logs enabled for required categories administrative, security, alert and policy.'\n    when valid_category_count > 0\n      then sett.name || ' logs enabled for ' || valid_categories || ' categories.'\n      else sett.name || ' logs not enabled for categories administrative, security, alert and policy.'\n  end as reason\n  \n  \nfrom\n  enabled_settings sett,\n  azure_subscription sub\nwhere\n  sub.subscription_id = sett.subscription_id;"
  PrimaryTable: azure_diagnostic_setting
  ListOfTables:
    - azure_diagnostic_setting
    - azure_subscription
  Parameters: []
Severity: low
Tags: {}
Integration_Type_Name:
  - azure_subscription
