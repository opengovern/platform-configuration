ID: azure_monitor_log_alert_create_update_public_ip_address
Title: "Ensure that Activity Log Alert exists for Create or Update Public IP Address rule"
Description: "Create an activity log alert for the Create or Update Public IP Addresses rule."
Query:
  Engine: CloudQL-v0.0.1
  QueryToExecute: |
    with alert_rule as
    (
      select
        alert.id as alert_id,
        alert.name as alert_name,
        alert.enabled,
        alert.location,
        alert.subscription_id
      from
        azure_log_alert as alert,
        jsonb_array_elements_text(scopes) as sc
      where
        alert.location ILIKE 'Global'
        and alert.enabled
        and sc = '/subscriptions/' || alert.subscription_id
        and
        (
          ( alert.condition -> 'allOf' @> '[{"equals":"Administrative","field":"category"}]'
            and alert.condition -> 'allOf' @> '[{"field": "resourceType", "equals": "microsoft.network/publicipaddresses"}]'
            and alert.condition -> 'allOf' @> '[{"field": "operationName", "equals": "Microsoft.Network/publicIPAddresses/write"}]'
          )
          or
          (
            alert.condition -> 'allOf' @> '[{"equals":"Administrative","field":"category"}]'
            and alert.condition -> 'allOf' @> '[{"field": "resourceType", "equals": "microsoft.network/publicipaddresses"}]'
            and jsonb_array_length(alert.condition -> 'allOf') = 2
          )
        )
        limit 1
    )
    select
      sub.subscription_id as resource,
      sub.og_account_id as og_account_id,
      sub.og_resource_id as og_resource_id,
      case
        when count(a.subscription_id) > 0 then 'ok'
        else 'alarm'
      end as status,
      case
        when count(a.subscription_id) > 0 then 'Activity Log Alert exists for Create or Update Public IP Address rule.'
        else 'Activity Log Alert does not exists for Create or Update Public IP Address rule.'
      end as reason

      , sub.display_name as subscription
    from
      azure_subscription sub
      left join alert_rule a on sub.subscription_id = a.subscription_id
    group by
      sub.og_account_id,
      sub.og_resource_id,
      sub._ctx,
      sub.subscription_id,
      sub.display_name;
  PrimaryTable: azure_log_alert
  ListOfTables:
    - azure_log_alert
    - azure_subscription
  Parameters: []
Severity: high
Tags:
  category:
    - Compliance
  cis:
    - "true"
  cis_item_id:
    - 5.2.9
  cis_level:
    - "1"
  cis_section_id:
    - "5.2"
  cis_type:
    - automated
  cis_version:
    - v1.5.0
  plugin:
    - azure
  service:
    - Azure/Monitor
Integration_Type_Name:
  - azure_subscription
