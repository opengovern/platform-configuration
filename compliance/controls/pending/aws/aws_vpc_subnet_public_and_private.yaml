Description: Ensure that all VPCs have both public and private subnets configured.
ID: aws_vpc_subnet_public_and_private
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables: []
  Parameters: []
  PrimaryTable: ""
  QueryToExecute: |
    WITH subnets_with_explicit_route AS (
      SELECT DISTINCT (a ->> 'SubnetId') AS all_sub
      FROM aws_vpc_route_table AS t, 
           jsonb_array_elements(associations) AS a
      WHERE a ->> 'SubnetId' IS NOT NULL
    ), public_subnets_with_explicit_route AS (
      SELECT DISTINCT a ->> 'SubnetId' AS SubnetId
      FROM aws_vpc_route_table AS t, 
           jsonb_array_elements(associations) AS a, 
           jsonb_array_elements(routes) AS r
      WHERE r ->> 'DestinationCidrBlock' = '0.0.0.0/0'
        AND (
          r ->> 'GatewayId' LIKE 'igw-%'
          OR r ->> 'NatGatewayId' LIKE 'nat-%'
        )
        AND a ->> 'SubnetId' IS NOT NULL
    ), public_subnets_with_implicit_route AS (
      SELECT DISTINCT route_table_id, vpc_id, region
      FROM aws_vpc_route_table AS t, 
           jsonb_array_elements(associations) AS a, 
           jsonb_array_elements(routes) AS r
      WHERE a ->> 'Main' = 'true'
        AND r ->> 'DestinationCidrBlock' = '0.0.0.0/0'
        AND (
          r ->> 'GatewayId' LIKE 'igw-%'
          OR r ->> 'NatGatewayId' LIKE 'nat-%'
        )
    ), subnet_accessibility AS (
      SELECT subnet_id, vpc_id,
        CASE
          WHEN s.subnet_id IN (
            SELECT all_sub
            FROM subnets_with_explicit_route
            WHERE all_sub NOT IN (SELECT SubnetId FROM public_subnets_with_explicit_route)
          ) THEN 'private'
          WHEN p.SubnetId IS NOT NULL
            OR s.vpc_id IN (SELECT vpc_id FROM public_subnets_with_implicit_route)
          THEN 'public'
          ELSE 'private'
        END AS access
      FROM aws_vpc_subnet AS s
      LEFT JOIN public_subnets_with_explicit_route AS p 
        ON p.SubnetId = s.subnet_id
    )
    SELECT arn AS resource,
      CASE
        WHEN v.vpc_id NOT IN (SELECT vpc_id FROM subnet_accessibility) THEN 'alarm'
        WHEN 'public' IN (
          SELECT access 
          FROM subnet_accessibility 
          WHERE vpc_id = v.vpc_id
        ) AND 'private' IN (
          SELECT access 
          FROM subnet_accessibility 
          WHERE vpc_id = v.vpc_id
        ) THEN 'ok'
        WHEN 'public' IN (
          SELECT access 
          FROM subnet_accessibility 
          WHERE vpc_id = v.vpc_id
        ) AND NOT 'private' IN (
          SELECT access 
          FROM subnet_accessibility 
          WHERE vpc_id = v.vpc_id
        ) THEN 'alarm'
        WHEN 'private' IN (
          SELECT access 
          FROM subnet_accessibility 
          WHERE vpc_id = v.vpc_id
        ) AND NOT 'public' IN (
          SELECT access 
          FROM subnet_accessibility 
          WHERE vpc_id = v.vpc_id
        ) THEN 'alarm'
      END AS status,
      CASE
        WHEN v.vpc_id NOT IN (SELECT vpc_id FROM subnet_accessibility) THEN v.title || ' has no subnet.'
        WHEN 'public' IN (
          SELECT access 
          FROM subnet_accessibility 
          WHERE vpc_id = v.vpc_id
        ) AND 'private' IN (
          SELECT access 
          FROM subnet_accessibility 
          WHERE vpc_id = v.vpc_id
        ) THEN v.title || ' having both private and public subnet(s).'
        WHEN 'public' IN (
          SELECT access 
          FROM subnet_accessibility 
          WHERE vpc_id = v.vpc_id
        ) AND NOT 'private' IN (
          SELECT access 
          FROM subnet_accessibility 
          WHERE vpc_id = v.vpc_id
        ) THEN v.title || ' having only public subnet(s).'
        WHEN 'private' IN (
          SELECT access 
          FROM subnet_accessibility 
          WHERE vpc_id = v.vpc_id
        ) AND NOT 'public' IN (
          SELECT access 
          FROM subnet_accessibility 
          WHERE vpc_id = v.vpc_id
        ) THEN v.title || ' having only private subnet(s).'
      END AS reason
    FROM aws_vpc AS v;
Severity: low
Tags: {}
Title: VPCs should have both public and private subnets configured