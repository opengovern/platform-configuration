Description: The principle of least privilege should be followed and only necessary privileges should be assigned instead of allowing full administrative access.
ID: azure_cis_v200_1_23
IntegrationType:
  - azure_subscription
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables:
    - azure_role_definition
    - azure_subscription
  Parameters: []
  PrimaryTable: azure_role_definition
  QueryToExecute: |
    WITH owner_custom_roles AS (
      SELECT
        role_name,
        role_type,
        og_account_id,
        og_resource_id,
        title,
        action,
        _ctx,
        subscription_id
      FROM
        azure_role_definition,
        jsonb_array_elements(permissions) AS s,
        jsonb_array_elements_text(s -> 'actions') AS action
      WHERE
        role_type = 'CustomRole'
        AND action IN ('*', '*:*')
    )
    SELECT
      cr.subscription_id AS resource,
      cr.og_account_id AS og_account_id,
      cr.og_resource_id AS og_resource_id,
      CASE
        WHEN COUNT(*) > 0 THEN 'alarm'
        ELSE 'ok'
      END AS status,
      CASE
        WHEN COUNT(*) = 1 THEN 'There is one custom owner role.'
        WHEN COUNT(*) > 1 THEN 'There are ' || COUNT(*) || ' custom owner roles.'
        ELSE 'There are no custom owner roles.'
      END AS reason
    FROM
      owner_custom_roles cr,
      azure_subscription sub
    WHERE
      sub.subscription_id = cr.subscription_id
    GROUP BY
      cr.subscription_id,
      cr._ctx,
      cr.og_account_id,
      cr.og_resource_id,
      sub.display_name;
Severity: low
Tags: {}
Title: 1.23 Ensure That No Custom Subscription Administrator Roles Exist