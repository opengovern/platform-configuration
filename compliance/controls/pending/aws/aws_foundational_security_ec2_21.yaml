Description: This control checks if default ports for SSH/RDP ingress traffic for network access control lists (NACLs) is unrestricted. The rule fails if a NACL inbound entry allows a source CIDR block of '0.0.0.0/0' or '::/0' for ports 22 or 3389.
ID: aws_foundational_security_ec2_21
IntegrationType:
  - aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables: []
  Parameters: []
  PrimaryTable: ""
  QueryToExecute: |
    WITH bad_rules AS (
        SELECT
            network_acl_id,
            COUNT(*) AS num_bad_rules,
            tags,
            region,
            account_id
        FROM
            aws_vpc_network_acl,
            jsonb_array_elements(entries) AS att
        WHERE
            att ->> 'Egress' = 'false'
            AND (
                att ->> 'CidrBlock' = '0.0.0.0/0'
                OR att ->> 'Ipv6CidrBlock' = '::/0'
            )
            AND att ->> 'RuleAction' = 'allow'
            AND (
                (
                    att ->> 'Protocol' = '-1'
                    AND att ->> 'PortRange' IS NULL
                )
                OR (
                    (att -> 'PortRange' ->> 'From')::int <= 22
                    AND (att -> 'PortRange' ->> 'To')::int >= 22
                    AND att ->> 'Protocol' IN ('6', '17')
                )
                OR (
                    (att -> 'PortRange' ->> 'From')::int <= 3389
                    AND (att -> 'PortRange' ->> 'To')::int >= 3389
                    AND att ->> 'Protocol' IN ('6', '17')
                )
            )
        GROUP BY
            network_acl_id,
            region,
            account_id,
            tags
        ORDER BY
            network_acl_id,
            region,
            account_id,
            tags
    ),
    aws_vpc_network_acls AS (
        SELECT
            network_acl_id,
            tags,
            partition,
            region,
            account_id
        FROM
            aws_vpc_network_acl
        ORDER BY
            network_acl_id,
            region,
            account_id
    )
    SELECT
        'arn:' || acl.partition || ':ec2:' || acl.region || ':' || acl.account_id || ':network-acl/' || acl.network_acl_id AS resource,
        CASE
            WHEN bad_rules.network_acl_id IS NULL THEN 'ok'
            ELSE 'alarm'
        END AS status,
        CASE
            WHEN bad_rules.network_acl_id IS NULL THEN acl.network_acl_id || ' does not allow ingress to port 22 or 3389 from 0.0.0.0/0 or ::/0.'
            ELSE acl.network_acl_id || ' contains ' || bad_rules.num_bad_rules || ' rule(s) allowing ingress to port 22 or 3389 from 0.0.0.0/0 or ::/0.'
        END AS reason
    FROM
        aws_vpc_network_acls AS acl
        LEFT JOIN bad_rules ON bad_rules.network_acl_id = acl.network_acl_id
Severity: medium
Tags: {}
Title: 21 Network ACLs should not allow ingress from 0.0.0.0/0 to port 22 or port 3389