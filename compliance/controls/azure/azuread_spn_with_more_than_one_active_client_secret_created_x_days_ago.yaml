Description: SPNs in AzureAD should not have more than one active Client Secret created X days ago
ID: azuread_spn_with_active_client_secret_created_x_days_ago
IntegrationType:
  - azure_subscription
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables:
    - azuread_service_principal
    - azuread_spn
  Parameters:
    - Key: azureadClientSecretExpireDays
      Required: true
  PrimaryTable: azuread_service_principal
  QueryToExecute: |
    WITH azuread_spn AS (
      SELECT
        id,
        display_name,
        og_account_id,
        og_resource_id,
        subscription_id,
        (
          SELECT COUNT(*)
          FROM jsonb_array_elements(password_credentials) AS pc
          WHERE (pc ->> 'EndDateTime')::timestamp > NOW() AND
            NOW() - (pc ->> 'StartDateTime')::timestamp > '{{.azureadClientSecretExpireDays}} days'::interval
        ) AS active_client_secret_count,
        (
          SELECT STRING_AGG(pc ->> 'DisplayName', ', ')
          FROM jsonb_array_elements(password_credentials) AS pc
          WHERE (pc ->> 'EndDateTime')::timestamp > NOW() AND
            NOW() - (pc ->> 'StartDateTime')::timestamp > '{{.azureadClientSecretExpireDays}} days'::interval
        ) AS Ids
      FROM
        azuread_service_principal
    )
    SELECT
      id AS resource,
      CASE
        WHEN active_client_secret_count > 1 THEN 'alarm'
        ELSE 'ok'
      END AS status,
      CASE
        WHEN active_client_secret_count > 0 THEN display_name || ' has ' || active_client_secret_count || ' active client secrets created {{.azureadClientSecretExpireDays}} days ago: [' || Ids || ']'
        ELSE display_name || ' has no active client secrets created {{.azureadClientSecretExpireDays}} days ago'
      END AS reason,
      og_account_id,
      og_resource_id,
      subscription_id
    FROM
      azuread_spn
Severity: high
Tags:
  score_service_name:
    - Azure Active Directory (Azure AD)
Title: Service Principal Keys in AzureAD need to comply with Key Rotation Policy