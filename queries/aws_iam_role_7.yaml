Description: Allows users to query IAM Roles to gain insights into their permissions,
  trust policies, and associated metadata.
ID: aws_iam_role_7
IntegrationTypeName:
- aws_cloud_account
Query:
  Engine: CloudQL-v0.0.1
  ListOfTables: []
  Parameters: []
  PrimaryTable: null
  QueryToExecute: "with roles as (\n  select\n    name,\n    attached_policy_arns\n\
    \  from\n    aws_iam_role\n  where\n    name in ('AWSServiceRoleForSSO', 'AWSServiceRoleForRDS')\n\
    ),\npolicies as (\n  select\n    name,\n    arn,\n    policy_std\n  from\n   \
    \ aws_iam_policy\n),\nrole1_permissions as (\n  select\n    r.name,\n    a.action,\n\
    \    a.access_level,\n    a.description\n  from\n    roles as r,\n    jsonb_array_elements_text(r.attached_policy_arns)\
    \ as pol_arn,\n    policies as p,\n    jsonb_array_elements(p.policy_std -> 'Statement')\
    \ as stmt,\n    jsonb_array_elements_text(stmt -> 'Action') as action_glob,\n\
    \    glob (action_glob) as action_regex\n    join aws_iam_action a on a.action\
    \ like action_regex\n  where\n    pol_arn = p.arn\n    and stmt ->> 'Effect' =\
    \ 'Allow'\n    and r.name = 'AWSServiceRoleForSSO'\n),\nrole2_permissions as (\n\
    \  select\n    r.name,\n    a.action,\n    a.access_level,\n    a.description\n\
    \  from\n    roles as r,\n    jsonb_array_elements_text(r.attached_policy_arns)\
    \ as pol_arn,\n    policies as p,\n    jsonb_array_elements(p.policy_std -> 'Statement')\
    \ as stmt,\n    jsonb_array_elements_text(stmt -> 'Action') as action_glob,\n\
    \    glob (action_glob) as action_regex\n    join aws_iam_action a on a.action\
    \ like action_regex\n  where\n    pol_arn = p.arn\n    and stmt ->> 'Effect' =\
    \ 'Allow'\n    and r.name = 'AWSServiceRoleForRDS'\n)\nselect\n  *\nfrom\n  role2_permissions\n\
    where\n  action not in ( select action from role1_permissions)\norder by\n  action;"
Tags:
  cloud_identity_security:
  - 'true'
  cloud_provider:
  - aws
  cloud_service:
  - IAM
Title: Find All AWS IAM Roles Permissions and Trust Policies
