ID: azure_compute_vm_network_traffic_data_collection_linux_agent_installed
Title: "Network traffic data collection agent should be installed on Linux virtual machines"
Description: "Security Center uses the Microsoft Dependency agent to collect network traffic data from your Azure virtual machines to enable advanced network protection features such as traffic visualization on the network map, network hardening recommendations and specific network threats."
Query:
  Engine: CloudQL-v0.0.1
  QueryToExecute: "with agent_installed_vm as (\n  select\n    distinct a.vm_id\n  from\n    azure_compute_virtual_machine as a,\n    jsonb_array_elements(extensions) as b\n  where\n    b ->> 'ExtensionType' = 'DependencyAgentLinux'\n    and b ->> 'Publisher' = 'Microsoft.Azure.Monitoring.DependencyAgent'\n    and b ->> 'ProvisioningState' = 'Succeeded'\n)\nselect\n  a.vm_id as resource,\n  a.og_account_id as og_account_id,\n  a.og_resource_id as og_resource_id,\n  case\n    when a.os_type <> 'Linux' then 'skip'\n    when b.vm_id is not null then 'ok'\n    else 'alarm'\n  end as status,\n  case\n    when a.os_type <> 'Linux' then a.title || ' is of ' || a.os_type || ' operating system.'\n    when b.vm_id is not null then a.title || ' have data collection agent installed.'\n    else a.title || ' data collection agent not installed.'\n  end as reason\n  \n  , a.resource_group as resource_group\n  , sub.display_name as subscription\nfrom\n  azure_compute_virtual_machine as a\n  left join agent_installed_vm as b on a.vm_id = b.vm_id,\n  azure_subscription as sub\nwhere\n  sub.subscription_id = a.subscription_id;\n"
  PrimaryTable: azure_compute_virtual_machine
  ListOfTables:
    - azure_compute_virtual_machine
    - azure_subscription
  Parameters: []
Severity: medium
Tags:
  hipaa_hitrust_v92:
    - "true"
  nist_sp_800_53_rev_5:
    - "true"
  service:
    - Azure/Compute
IntegrationType:
  - azure_subscription
